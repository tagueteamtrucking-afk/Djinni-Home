<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Tracy — Cathedral Studio</title>
  <link rel="stylesheet" href="../asset/css/style.css"/>
  
<!-- Polyfill for older Safari/iPadOS so import maps work -->
<script async src="https://cdn.jsdelivr.net/npm/es-module-shims@1.10.0/dist/es-module-shims.min.js"></script>
<script type="importmap">
{
  "imports": {
    "three": "https://cdn.jsdelivr.net/npm/three@0.162.0/build/three.module.js",
    "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.162.0/examples/jsm/",
    "@pixiv/three-vrm": "https://cdn.jsdelivr.net/npm/@pixiv/three-vrm@2.0.3/lib/three-vrm.module.js"
  }
}
</script>

</head>
<body data-title="Tracy — Cathedral Studio"
      data-model="../asset/models/tracy.vrm">
  <div class="topbar">
    <a href="plaza.html">← Plaza</a>
    <div style="margin-left:auto"></div>
    <span class="small">Tip: Drop your tracy.vrm in asset/models/</span>
  </div>
  <canvas id="scene"></canvas>
  <div id="hud">Booting…</div>

  <div class="panel">
    <h3>Tracy’s Tools</h3>
    <div class="row">
      <a class="btn" href="https://www.meshy.ai/" target="_blank">Open Meshy</a>
      <a class="btn" href="https://play.google.com/store/search?q=ai%20arta" target="_blank">Open AI Arta</a>
    </div>
    <hr style="border-color:#1a2130;opacity:.35;margin:.75rem 0"/>
    <label>Model URL (.vrm)</label>
    <input id="vrmUrl" type="url" placeholder="../asset/models/tracy.vrm"/>
    <button class="btn" id="loadBtn" style="margin-top:.5rem">Load VRM</button>
    <div class="small" style="margin-top:.5rem">You can paste a full URL or keep the default local path.</div>
  </div>

  <script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
    import { VRMLoaderPlugin } from '@pixiv/three-vrm';

    const canvas = document.getElementById('scene');
    const hud = document.getElementById('hud');
    const paramUrl = document.body.dataset.model || '../asset/models/tracy.vrm';

    const renderer = new THREE.WebGLRenderer({ antialias:true, canvas });
    renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
    renderer.setSize(innerWidth, innerHeight);

    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x0d1117);

    const camera = new THREE.PerspectiveCamera(70, innerWidth/innerHeight, 0.1, 100);
    camera.position.set(0, 1.45, 3);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.target.set(0,1.4,0); controls.update();

    const hemi = new THREE.HemisphereLight(0xffffff, 0x223344, 1.1); scene.add(hemi);
    const dir = new THREE.DirectionalLight(0xffffff, 0.8); dir.position.set(5,10,7); scene.add(dir);

    const floor = new THREE.Mesh(
      new THREE.CircleGeometry(4.5, 64),
      new THREE.MeshStandardMaterial({ color: 0x1c2333, roughness:0.9, metalness:0.05 })
    ); floor.rotation.x = -Math.PI/2; scene.add(floor);

    let currentVRM = null;
    async function loadVRM(url) {
      hud.textContent = 'Loading VRM…';
      // GLTFLoader + VRM plugin (v2)
      const loader = new GLTFLoader();
      loader.register( parser => new VRMLoaderPlugin(parser) );
      const gltf = await loader.loadAsync(url);
      const vrm = gltf.userData.vrm;
      if (!vrm) throw new Error('No VRM data found in GLTF.');
      if (currentVRM) scene.remove(currentVRM.scene);
      currentVRM = vrm;
      vrm.scene.rotation.y = Math.PI; // face camera
      scene.add(vrm.scene);
      hud.textContent = 'Loaded VRM. Rotate, zoom, or add wings in Wings Lab.';
    }

    // initial attempt
    loadVRM(paramUrl).catch(err => { hud.textContent = 'Load failed: ' + err.message; console.error(err); });

    function onResize() { camera.aspect = innerWidth/innerHeight; camera.updateProjectionMatrix(); renderer.setSize(innerWidth, innerHeight); }
    addEventListener('resize', onResize);

    document.getElementById('loadBtn').onclick = () => {
      const v = (document.getElementById('vrmUrl').value || paramUrl).trim();
      loadVRM(v).catch(err => { hud.textContent = 'Load failed: ' + err.message; console.error(err); });
    };

    renderer.setAnimationLoop(()=>{ renderer.render(scene, camera); });
  </script>
</body>
</html>
