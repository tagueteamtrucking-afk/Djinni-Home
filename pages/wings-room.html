<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Wings Room</title>

  <!-- Inline safety styles -->
  <style>
    :root{color-scheme:dark}
    html,body{height:100%;margin:0}
    body{background:#0f0f14;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    #scene{width:100vw;height:100vh;display:block;background:#0b0b10}
    .topbar{
      position:fixed;top:0;left:0;right:0;height:48px;
      display:flex;gap:12px;align-items:center;padding:0 12px;
      background:linear-gradient(90deg,#1a2030,#222a3a);border-bottom:1px solid #2f3a57;color:#e9efff;z-index:10
    }
    .topbar a{color:#9ed0ff;text-decoration:none}
    .topbar label{display:flex;align-items:center;gap:6px;font-size:14px}
    .topbar select,.topbar button{
      background:#1f2740;border:1px solid #33436e;color:#e9efff;border-radius:8px;padding:6px 8px
    }
    .topbar select{max-width:240px}
    #hud{
      position:fixed;left:10px;bottom:10px;z-index:20;
      font-size:12px;background:#141a2aE6;border:1px solid #2c3758;
      color:#cfe3ff;padding:6px 10px;border-radius:8px;max-width:70vw;white-space:pre-wrap
    }
    body::before{content:"";display:block;height:48px}
  </style>
</head>
<body>
  <div class="topbar">
    <a href="./plaza.html">← Plaza</a>

    <label>Model:
      <select id="modelSelect"><option>Loading…</option></select>
    </label>

    <label>Wing:
      <select id="wingSelect"><option>Loading…</option></select>
    </label>

    <button id="loadVrmBtn">Load VRM</button>
    <button id="loadWingBtn">Load Wing</button>
    <button id="saveBtn" title="Save placement for this model">Save</button>
    <button id="loadBtn" title="Load saved placement for this model">Load</button>
  </div>

  <canvas id="scene"></canvas>
  <div id="hud">Booting…</div>

  <script type="module">
    // ====== CONFIG: only these two files must exist in your repo ======
    const MODELS_MANIFEST = "../data/models.json";
    const WINGS_MANIFEST  = "../data/wings.json";
    // ================================================================

    const hud = document.getElementById('hud');
    const modelSelect = document.getElementById('modelSelect');
    const wingSelect  = document.getElementById('wingSelect');

    // Show any error in HUD so a black page isn't silent
    addEventListener('error', e => hud.textContent = `Error: ${e.message}`);
    addEventListener('unhandledrejection', e => {
      const msg = (e.reason && e.reason.message) ? e.reason.message : String(e.reason);
      hud.textContent = `Promise error: ${msg}`;
    });

    // Load libs from CDN
    const THREE = await import("https://unpkg.com/three@0.152.2/build/three.module.js");
    const { OrbitControls } = await import("https://unpkg.com/three@0.152.2/examples/jsm/controls/OrbitControls.js");
    const { GLTFLoader } = await import("https://unpkg.com/three@0.152.2/examples/jsm/loaders/GLTFLoader.js");
    const { FBXLoader } = await import("https://unpkg.com/three@0.152.2/examples/jsm/loaders/FBXLoader.js");
    const { VRM, VRMUtils } = await import("https://unpkg.com/@pixiv/three-vrm@2.0.5/lib/three-vrm.module.js");
    const { TransformControls } = await import("https://unpkg.com/three@0.152.2/examples/jsm/controls/TransformControls.js");

    // Scene
    const canvas = document.getElementById('scene');
    const renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
    renderer.setPixelRatio(devicePixelRatio);
    renderer.setSize(innerWidth, innerHeight);

    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x111116);

    const camera = new THREE.PerspectiveCamera(35, innerWidth/innerHeight, 0.1, 100);
    camera.position.set(0, 1.5, 3);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;

    scene.add(new THREE.AmbientLight(0xffffff, 0.6));
    const key = new THREE.DirectionalLight(0xffffff, 0.9);
    key.position.set(3, 5, 4);
    scene.add(key);

    const grid = new THREE.GridHelper(10, 20, 0x666666, 0x333333);
    grid.position.y = -1;
    scene.add(grid);

    const clock = new THREE.Clock();
    let vrm = null, wing = null, gizmo = null;

    addEventListener('resize', () => {
      camera.aspect = innerWidth/innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(innerWidth, innerHeight);
    });

    // Manifest helpers (accept several shapes)
    const normModels = raw => {
      const list = Array.isArray(raw?.models) ? raw.models : raw;
      if (Array.isArray(list) && list.length && typeof list[0] === 'string') {
        return list.map((p,i)=>({id:`m${i}`, name:p.split('/').pop(), path:p}));
      }
      return (list||[]).map((m,i)=>({
        id:   m.id   || m.name || `m${i}`,
        name: m.name || m.title|| m.id || m.path?.split('/').pop() || `Model ${i+1}`,
        path: m.path || m.url  || m.src|| m.file || m.model || m.vrm
      })).filter(x=>!!x.path);
    };
    const normWings = raw => {
      const list = Array.isArray(raw?.wings) ? raw.wings : raw;
      return (list||[]).map((w,i)=>({
        id: w.id || w.name || `w${i}`,
        name: w.name || w.id || w.path?.split('/').pop() || `Wing ${i+1}`,
        path: w.path || w.url || w.src || w.file,
        textures: w.textures || []
      })).filter(x=>!!x.path);
    };

    // Load manifests
    async function loadManifests(){
      hud.textContent = "Fetching manifests…";
      const [mJ, wJ] = await Promise.all([
        fetch(MODELS_MANIFEST).then(r=>r.ok?r.json():Promise.reject(new Error(`models.json ${r.status}`))),
        fetch(WINGS_MANIFEST ).then(r=>r.ok?r.json():Promise.reject(new Error(`wings.json ${r.status}`)))
      ]);
      const models = normModels(mJ);
      const wings  = normWings(wJ);

      if (!models.length) hud.textContent = "No entries in models.json";
      if (!wings.length)  hud.textContent = "No entries in wings.json";

      modelSelect.innerHTML = models.map(m=>`<option value="${m.id}">${m.name}</option>`).join("");
      wingSelect.innerHTML  = wings.map(w=>`<option value="${w.id}">${w.name}</option>`).join("");

      // Lookups
      const byId = (arr,id)=>arr.find(x=>x.id===id);
      async function loadVRMById(id){
        const m = byId(models,id);
        if (!m) return alert("Model not found");
        await loadVRM(m.path);
      }
      async function loadWingById(id){
        const w = byId(wings,id);
        if (!w) return alert("Wing not found");
        await loadWing(w.path, w.textures);
      }

      // Wire buttons
      document.getElementById('loadVrmBtn').onclick  = () => loadVRMById(modelSelect.value);
      document.getElementById('loadWingBtn').onclick = () => loadWingById(wingSelect.value);
      document.getElementById('saveBtn').onclick = savePlacement;
      document.getElementById('loadBtn').onclick = loadPlacement;

      // Auto-load first model (if any)
      if (models.length) loadVRMById(models[0].id);
    }

    async function loadVRM(url){
      hud.textContent = `Loading VRM: ${url}`;
      const loader = new GLTFLoader();
      const gltf = await loader.loadAsync(url);
      VRMUtils.removeUnnecessaryJoints(gltf.scene);
      const loaded = await VRM.from(gltf); // ✅ v2 API
      if (vrm) scene.remove(vrm.scene);
      vrm = loaded;
      vrm.scene.rotation.y = Math.PI;
      scene.add(vrm.scene);
      hud.textContent = `VRM loaded: ${url.split('/').pop()}`;
    }

    async function loadWing(url, textures=[]){
      if (!vrm) return alert("Load a VRM first");
      hud.textContent = `Loading Wing: ${url}`;
      const loader = new FBXLoader();
      const obj = await loader.loadAsync(url);

      obj.traverse(n=>{
        if (n.isMesh) {
          if (!n.material) n.material = new THREE.MeshStandardMaterial({color:0xffffff});
          if (textures.length){
            new THREE.TextureLoader().load(textures[0], tex=>{
              tex.flipY = false;
              n.material.map = tex;
              n.material.needsUpdate = true;
            }, undefined, err=>{
              hud.textContent = `Texture load failed: ${textures[0]}`;
              console.warn(err);
            });
          }
        }
      });

      const spine = vrm.humanoid.getBoneNode("spine") || vrm.humanoid.getBoneNode("chest") || vrm.scene;
      obj.scale.setScalar(0.01);
      obj.position.set(0, 0.2, -0.05);
      obj.rotation.set(0, Math.PI, 0);
      spine.add(obj);

      if (wing && wing.parent) wing.parent.remove(wing);
      wing = obj;

      if (gizmo) { gizmo.detach(); scene.remove(gizmo); }
      gizmo = new TransformControls(camera, renderer.domElement);
      gizmo.addEventListener("dragging-changed", e => controls.enabled = !e.value);
      gizmo.attach(wing);
      scene.add(gizmo);

      addEventListener('keydown', e=>{
        if (!gizmo) return;
        if (e.key==='1') gizmo.setMode('translate');
        if (e.key==='2') gizmo.setMode('rotate');
        if (e.key==='3') gizmo.setMode('scale');
      });

      hud.textContent = `Wing loaded: ${url.split('/').pop()}  (1=Move 2=Rotate 3=Scale)`;
    }

    function savePlacement(){
      if (!vrm || !wing) return alert("Load VRM and Wing first");
      const key = `wingPlacement:${vrm.meta?.name || 'avatar'}`;
      const data = {
        position: {x:wing.position.x,y:wing.position.y,z:wing.position.z},
        rotation: {x:wing.rotation.x,y:wing.rotation.y,z:wing.rotation.z},
        scale:    {x:wing.scale.x,   y:wing.scale.y,   z:wing.scale.z}
      };
      localStorage.setItem(key, JSON.stringify(data));
      hud.textContent = `Saved placement → ${key}`;
    }

    function loadPlacement(){
      if (!vrm || !wing) return alert("Load VRM and Wing first");
      const key = `wingPlacement:${vrm.meta?.name || 'avatar'}`;
      const json = localStorage.getItem(key);
      if (!json) return alert("No saved placement for this model");
      const p = JSON.parse(json);
      wing.position.set(p.position.x, p.position.y, p.position.z);
      wing.rotation.set(p.rotation.x, p.rotation.y, p.rotation.z);
      wing.scale.set(p.scale.x, p.scale.y, p.scale.z);
      hud.textContent = `Loaded placement ← ${key}`;
    }

    // Boot
    loadManifests().catch(err=>{
      hud.textContent = `Manifest error: ${err.message}\nCheck that:\n- ${MODELS_MANIFEST}\n- ${WINGS_MANIFEST}\nexist and have valid JSON.`;
    });

    // Render loop
    (function loop(){
      requestAnimationFrame(loop);
      const dt = clock.getDelta();
      if (vrm) vrm.update(dt);
      controls.update();
      renderer.render(scene, camera);
    })();
  </script>
</body>
</html>
