<!doctype html><html lang="en"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Wing Room — Attach & Lock</title>
<link rel="stylesheet" href="../asset/css/town.css"/></head><body>
<div class="topbar"><a href="../index.html">← Town</a><strong>Wing Room</strong><a href="./plaza.html">Plaza</a></div>
<div class="spacer"></div><div class="container">
<div class="grid">
  <div class="card">
    <h3>1) Choose Character & Wings</h3>
    <div class="alert">Use a repo path or pick a local file (for preview only).</div>
    <div class="row"><label>Character</label><select id="character"></select></div>
    <div class="row"><label>VRM path (repo)</label><input id="vrmPath" placeholder="./asset/models/whitestar.vrm"/></div>
    <div class="row"><label>VRM local file (preview)</label><input id="vrmFile" type="file" accept=".vrm"/></div>
    <div class="row"><label>Wings path (repo)</label><input id="wingsPath" placeholder="./asset/wings/angel/angel.glb"/></div>
    <div class="row"><label>Wings local file (preview)</label><input id="wingsFile" type="file" accept=".glb,.gltf"/></div>
    <div class="flex"><label>Bone</label><select id="boneHint"><option>UpperChest</option><option selected>Chest</option><option>Spine</option></select><button class="btn" id="load">Load Preview</button></div>
  </div>
  <div class="card">
    <h3>2) Fit Controls</h3>
    <div class="controls">
      <div class="row"><span>Pos X</span><input id="px" type="range" min="-1" max="1" step="0.005" value="0"/></div>
      <div class="row"><span>Pos Y</span><input id="py" type="range" min="-1" max="1" step="0.005" value="0.1"/></div>
      <div class="row"><span>Pos Z</span><input id="pz" type="range" min="-1" max="1" step="0.005" value="-0.05"/></div>
      <div class="row"><span>Rot X°</span><input id="rx" type="range" min="-180" max="180" step="0.5" value="0"/></div>
      <div class="row"><span>Rot Y°</span><input id="ry" type="range" min="-180" max="180" step="0.5" value="0"/></div>
      <div class="row"><span>Rot Z°</span><input id="rz" type="range" min="-180" max="180" step="0.5" value="0"/></div>
      <div class="row"><span>Scale X</span><input id="sx" type="range" min="0.1" max="3" step="0.01" value="1"/></div>
      <div class="row"><span>Scale Y</span><input id="sy" type="range" min="0.1" max="3" step="0.01" value="1"/></div>
      <div class="row"><span>Scale Z</span><input id="sz" type="range" min="0.1" max="3" step="0.01" value="1"/></div>
    </div>
    <div class="flex"><button class="btn" id="attach">Attach & Save</button><button class="btn" id="download">Download models.json</button></div>
  </div>
</div>
<canvas id="scene"></canvas>
</div>
<script type="module">
import * as THREE from "https://unpkg.com/three@0.152.2/build/three.module.js"; import { OrbitControls } from "https://unpkg.com/three@0.152.2/examples/jsm/controls/OrbitControls.js"; import { GLTFLoader } from "https://unpkg.com/three@0.152.2/examples/jsm/loaders/GLTFLoader.js"; import * as VRM from "https://unpkg.com/@pixiv/three-vrm@3.2.0/lib/three-vrm.module.js";
import { loadModelsConfig, saveCharacterWings, addLights, fitOrbitToScene, loadVRM, loadWingsMesh, applyWingsToVRM } from "../asset/js/vrm-utils.js";
const S=id=>document.getElementById(id);
const canvas=S('scene'); const renderer=new THREE.WebGLRenderer({canvas,antialias:true}); renderer.setPixelRatio(devicePixelRatio); renderer.setSize(canvas.clientWidth,canvas.clientHeight);
const scene=new THREE.Scene(); scene.background=new THREE.Color(0x0c0a12);
const camera=new THREE.PerspectiveCamera(45,canvas.clientWidth/canvas.clientHeight,.1,100); camera.position.set(0,1.4,3); const controls=new OrbitControls(camera,renderer.domElement); addLights(scene);
const clock=new THREE.Clock(); addEventListener('resize',()=>{renderer.setSize(canvas.clientWidth,canvas.clientHeight);camera.aspect=canvas.clientWidth/canvas.clientHeight;camera.updateProjectionMatrix();});
let cfg=await loadModelsConfig(); let current=cfg.characters[0]?.id||null; let vrm=null, wings=null, wingsNode=null;
const char=S('character'); cfg.characters.forEach((c,i)=>{ const o=document.createElement('option'); o.value=c.id; o.textContent=c.name; char.appendChild(o); if(i===0) current=c.id; }); char.onchange=e=>current=e.target.value;
const deg2rad=d=>d*Math.PI/180;
async function loadPreview(){ while(scene.children.length) scene.remove(scene.children[0]); addLights(scene);
  const chosen=cfg.characters.find(c=>c.id===current); if(!chosen) return;
  const vrmFile=S('vrmFile').files[0]; const wingsFile=S('wingsFile').files[0];
  const vrmInput= vrmFile ? vrmFile : (S('vrmPath').value || chosen.vrm);
  const wingsInput= wingsFile ? wingsFile : S('wingsPath').value;
  const res=await loadVRM(vrmInput); vrm=res.vrm; scene.add(vrm.scene);
  wings=await loadWingsMesh(wingsInput); wingsNode=applyWingsToVRM(vrm,wings,S('boneHint').value); scene.add(wingsNode);
  const w=chosen.wings||{position:[0,0.1,-0.05],rotation:[0,0,0],scale:[1,1,1]};
  S('px').value=w.position[0]; S('py').value=w.position[1]; S('pz').value=w.position[2];
  S('rx').value=w.rotation[0]; S('ry').value=w.rotation[1]; S('rz').value=w.rotation[2];
  S('sx').value=w.scale[0]; S('sy').value=w.scale[1]; S('sz').value=w.scale[2];
  updateTransform(); fitOrbitToScene(controls,scene);
}
function updateTransform(){ if(!wingsNode) return; wingsNode.position.set(parseFloat(S('px').value),parseFloat(S('py').value),parseFloat(S('pz').value)); wingsNode.rotation.set(deg2rad(parseFloat(S('rx').value)),deg2rad(parseFloat(S('ry').value)),deg2rad(parseFloat(S('rz').value))); wingsNode.scale.set(parseFloat(S('sx').value),parseFloat(S('sy').value),parseFloat(S('sz').value)); }
;['px','py','pz','rx','ry','rz','sx','sy','sz'].forEach(id=>S(id).addEventListener('input',updateTransform));
S('load').onclick=loadPreview;
S('attach').onclick=()=>{ const chosen=cfg.characters.find(c=>c.id===current); if(!chosen) return; chosen.wings={enabled:true, asset:(S('wingsFile').files[0]?'(local preview only)':S('wingsPath').value), boneHint:S('boneHint').value, position:[parseFloat(S('px').value),parseFloat(S('py').value),parseFloat(S('pz').value)], rotation:[parseFloat(S('rx').value),parseFloat(S('ry').value),parseFloat(S('rz').value)], scale:[parseFloat(S('sx').value),parseFloat(S('sy').value),parseFloat(S('sz').value)]}; saveCharacterWings(chosen); alert('Attached for preview. Download models.json and commit to make it permanent.'); };
S('download').onclick=()=>{ const blob=new Blob([JSON.stringify(cfg,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='models.json'; a.click(); };
(function anim(){requestAnimationFrame(anim); const dt=clock.getDelta(); renderer.render(scene,camera);})();
</script></body></html>