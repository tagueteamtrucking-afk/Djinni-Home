<!doctype html>
<html lang="en"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Palace — Armory</title><link rel="stylesheet" href="../asset/css/town.css"/>
<script type="importmap">
{
  "imports": {
    "three": "https://unpkg.com/three@0.152.2/build/three.module.js",
    "three/addons/": "https://unpkg.com/three@0.152.2/examples/jsm/",
    "three/examples/jsm/": "https://unpkg.com/three@0.152.2/examples/jsm/",
    "@pixiv/three-vrm": "https://unpkg.com/@pixiv/three-vrm@2.0.5/lib/three-vrm.module.js"
  }
}
</script>

</head>
<body class="safe-pad">
<div class="topbar"><a href="../pages/plaza.html">← Plaza</a><strong>Palace — Armory</strong>
<label class="label">Model: <select id="modelSelect"><option>Loading…</option></select></label>
<label class="label">Wing: <select id="wingSelect"><option>Loading…</option></select></label>
<button id="loadVrmBtn" class="btn">Load VRM</button>
<button id="loadWingBtn" class="btn">Load Wing</button>
<button id="saveBtn" class="btn">Save</button>
<button id="loadBtn" class="btn">Load</button>
<span style="opacity:.8;font-size:12px;margin-left:6px">Hotkeys: 1=Move 2=Rotate 3=Scale</span>
</div>
<canvas id="scene"></canvas><div id="hud" class="hud">Booting…</div>
<script type="module">
const hud=document.getElementById('hud');addEventListener('error',e=>hud.textContent='Error: '+e.message);addEventListener('unhandledrejection',e=>hud.textContent='Promise error: '+(e.reason?.message||e.reason));

import * as THREE from "three";
import {{ OrbitControls }} from "three/addons/controls/OrbitControls.js";
import {{ GLTFLoader }} from "three/addons/loaders/GLTFLoader.js";
import {{ FBXLoader }} from "three/addons/loaders/FBXLoader.js";
import {{ TransformControls }} from "three/addons/controls/TransformControls.js";
import {{ VRM, VRMUtils }} from "@pixiv/three-vrm";

const MODELS="../data/models.json", WINGS="../data/wings.json";
const modelSelect=document.getElementById('modelSelect'),wingSelect=document.getElementById('wingSelect');
document.getElementById('loadVrmBtn').onclick=()=>loadVRMById(modelSelect.value);
document.getElementById('loadWingBtn').onclick=()=>loadWingById(wingSelect.value);
document.getElementById('saveBtn').onclick=savePlacement;document.getElementById('loadBtn').onclick=loadPlacement;

const canvas=document.getElementById('scene');const renderer=new THREE.WebGLRenderer({{canvas,antialias:true}});renderer.setPixelRatio(devicePixelRatio);renderer.setSize(innerWidth,innerHeight);
const scene=new THREE.Scene();scene.background=new THREE.Color(0x111116);
const camera=new THREE.PerspectiveCamera(35,innerWidth/innerHeight,0.1,100);camera.position.set(0,1.5,3);
const controls=new OrbitControls(camera,renderer.domElement);controls.enableDamping=true;
scene.add(new THREE.AmbientLight(0xffffff,0.7));const key=new THREE.DirectionalLight(0xffffff,1.0);key.position.set(3,5,4);scene.add(key);
const rim=new THREE.DirectionalLight(0x88aaff,0.3);rim.position.set(-4,3,-3);scene.add(rim);
const floor=new THREE.Mesh(new THREE.PlaneGeometry(10,10),new THREE.MeshStandardMaterial({{color:0x1b1f2b,roughness:0.9,metalness:0.05}}));floor.rotation.x=-Math.PI/2;floor.position.y=-1;scene.add(floor);
addEventListener('resize',()=>{{camera.aspect=innerWidth/innerHeight;camera.updateProjectionMatrix();renderer.setSize(innerWidth,innerHeight);}});

const normM=r=>{{const l=Array.isArray(r?.models)?r.models:r; if(Array.isArray(l)&&typeof l[0]==='string') return l.map((p,i)=>({{id:`m${{i}}`,name:p.split('/').pop(),path:p}})); return (l||[]).map((m,i)=>({{id:m.id||m.name||`m${{i}}`,name:m.name||m.title||m.id||m.path?.split('/').pop()||`Model ${{i+1}}`,path:m.path||m.url||m.src||m.file||m.model||m.vrm}})).filter(x=>x.path);}};
const normW=r=>{{const l=Array.isArray(r?.wings)?r.wings:r; return (l||[]).map((w,i)=>({{id:w.id||w.name||`w${{i}}`,name:w.name||w.id||w.path?.split('/').pop()||`Wing ${{i+1}}`,path:w.path||w.url||w.src||w.file,textures:w.textures||[]}})).filter(x=>x.path);}};
const models=normM(await fetch(MODELS).then(r=>r.json())), wings=normW(await fetch(WINGS).then(r=>r.json()));
modelSelect.innerHTML=models.map(m=>`<option value="${{m.id}}">${{m.name}}</option>`).join(""); wingSelect.innerHTML=wings.map(w=>`<option value="${{w.id}}">${{w.name}}</option>`).join("");

let vrm=null,wing=null,gizmo=null;const clock=new THREE.Clock();const byId=(a,id)=>a.find(x=>x.id===id);
async function loadVRMById(id){{const m=byId(models,id); if(!m) return alert('Model not found'); await loadVRM(m.path);}}
async function loadWingById(id){{const w=byId(wings,id);  if(!w) return alert('Wing not found');  await loadWing(w.path,w.textures);}}
async function loadVRM(url){{hud.textContent='Loading VRM: '+url; const gltf=await new GLTFLoader().loadAsync(url); VRMUtils.removeUnnecessaryJoints(gltf.scene); const loaded=await VRM.from(gltf); if(vrm)scene.remove(vrm.scene); vrm=loaded; vrm.scene.rotation.y=Math.PI; scene.add(vrm.scene); hud.textContent='VRM loaded: '+url.split('/').pop();}}
async function loadWing(url,tex=[]){{if(!vrm)return alert('Load a VRM first'); hud.textContent='Loading Wing: '+url; const obj=await new FBXLoader().loadAsync(url);
 obj.traverse(n=>{{if(n.isMesh){{if(!n.material)n.material=new THREE.MeshStandardMaterial({{color:0xffffff}}); if(tex.length){{new THREE.TextureLoader().load(tex[0],t=>{{t.flipY=false;n.material.map=t;n.material.needsUpdate=true;}});}}}}});
 const spine=vrm.humanoid.getBoneNode('spine')||vrm.humanoid.getBoneNode('chest')||vrm.scene; obj.scale.setScalar(0.01); obj.position.set(0,0.2,-0.05); obj.rotation.set(0,Math.PI,0); spine.add(obj);
 if(wing&&wing.parent)wing.parent.remove(wing); wing=obj; if(gizmo){{gizmo.detach();scene.remove(gizmo);}} gizmo=new TransformControls(camera,renderer.domElement); gizmo.addEventListener('dragging-changed',e=>controls.enabled=!e.value); gizmo.attach(wing); scene.add(gizmo);
 addEventListener('keydown',e=>{{if(!gizmo)return; if(e.key==='1')gizmo.setMode('translate'); if(e.key==='2')gizmo.setMode('rotate'); if(e.key==='3')gizmo.setMode('scale');}});
 hud.textContent='Wing loaded: '+url.split('/').pop()+' (1=Move 2=Rotate 3=Scale)';}}
function savePlacement(){{if(!vrm||!wing)return alert('Load VRM and Wing first'); const key='wingPlacement:'+(vrm.meta?.name||'avatar'); const d={{position:{{x:wing.position.x,y:wing.position.y,z:wing.position.z}},rotation:{{x:wing.rotation.x,y:wing.rotation.y,z:wing.rotation.z}},scale:{{x:wing.scale.x,y:wing.scale.y,z:wing.scale.z}}}}; localStorage.setItem(key,JSON.stringify(d)); hud.textContent='Saved → '+key;}}
function loadPlacement(){{if(!vrm||!wing)return alert('Load VRM and Wing first'); const key='wingPlacement:'+(vrm.meta?.name||'avatar'); const j=localStorage.getItem(key); if(!j)return alert('No saved placement'); const p=JSON.parse(j); wing.position.set(p.position.x,p.position.y,p.position.z); wing.rotation.set(p.rotation.x,p.rotation.y,p.rotation.z); wing.scale.set(p.scale.x,p.scale.y,p.scale.z); hud.textContent='Loaded ← '+key;}}
if(models.length)loadVRMById(models[0].id);
(function loop(){{requestAnimationFrame(loop);const dt=clock.getDelta();if(vrm)vrm.update(dt);controls.update();renderer.render(scene,camera);}})();
</script></body></html>
